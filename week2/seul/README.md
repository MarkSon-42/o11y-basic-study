# 관측 가능성

관측 가능성은 모니터링을 대체하는 개념이 아닌 모니터링과 구분되는 개념으로 **내부 시스템에 대한 이해를 기반으로 미래에 발생할 이벤트를 예측**하는 것을 의미한다.

관측 가능성은  **메트릭, 로그, 추적** 세 가지 구성요소로 이루어져있다.

</br>

# 메트릭

일정 시간 동안 측정된 데이터를 집계하고 이를 수치화한다. 예를 들어 큐의 대기 메시지 개수, 사용 중인 CPU와 메모리의 크기, 서비스에서 초당 처리하는 개수 등이 있다.

구글의 SRD 팀에서는 메트릭을 수집할 떄 네 가지 골든 시그널 **지연, 에러, 트래픽, 포화**에 집중해야 한다고 한다.

- **지연**: 서비스 요청 후 완료까지 걸리는 시간으로, 잠재적인 장애를 예측하는데 유용하다.
- **에러**: 에러는 정상(normal), 대기(pending), 파이어링(firing) 세 가지 상태가 있다. 초기 정상 상태에서 에러가 발견되면 대기 상태로 변하고, 에러가 계속 활성 상태일 때 파이어링 상태로 변한다.
- **트래픽**: 발생하는 요청의 양을 의미한다. 트래픽의 양이 급격하게 많아져 임계치를 초과하거나 포화 상태가 되면 지연과 에러가 발생하며, 최종적으로 장애에 이를 수 있다.
- **포화**: 전체 총 대역폭과 처리 가능한 트래픽에 대비해서 현재 트래픽 혹은 대역폭이 어느 정도인지 이해할 수 있는 지표다.

</br>

# 추적

마이크로서비스가 시스템을 경유하며 트랜잭션을 처리하는 과정에서 발생하는 세부적인 정보를 보여준다. 또한 트랜잭션이 시스템을 이동하는 경로, 트랜잭션을 처리하는 과정에서 발생하는 대기시간과 지연시간, 병목현상이나 에러는 일으키는 원인을 문맥과 로그, 태그 등의 메타데이터에 출력한다.

</br>

# 로그

애플리케이션 실행 시 생성되는 텍스트 라인으로 구조적인 JSON 형식이나 비구조적인 텍스트 형식으로 출력된다.

여러 소스에서 수집한 로그 데이터를 좀 더 쉽게 분석하고 검색하기 위해서는 로그를 표준화하고 공통 형식을 정의해야 한다. 또한 로그 데이터에서 시스템을 이해하기 위한 필수 정보를 포함해야 한다. 아래는 로그에 포함해야 할 정보다.

- **타임스탬프**: 이벤트가 발생한 순서를 파악할 수 있다.
- **식별자**: 주문 ID, 트랜잭션 ID 등 고유 식별자는 여러 소스의 데이터를 상호 참조할 때 도움이 된다.
- **소스**: 호스트, 클래스, 모듈, 함수, 파일명 등을 작성하여 디버깅을 쉽게 할 수 있다.
- **레벨 또는 카테고리**: 일반적인 로그 레벨에는 ERROR, DEBUG, INFO, WARN 값이 쓰인다. 특정 로그 레벨을 가진 메시지를 찾아낼 때 유용하다.

</br>

# 상관관계

로그, 메트릭, 추적의 상관관계를 정의하면 서로 다른 데이터를 결합하여 관측 가능성의 활용도를 높일 수 있다.

아래는 사용자 화면에서 운영자가 상관관계를 다루는 간략한 방법이다.

- 메트릭에서 추적
- 추적에서 로그

운영자는 메트릭의 히스토그램을 통해 장애 또는 이상 현상을 발견한다. → 히스토그램에서 점으로 출력되는 이그젬플러를 클릭하면 traceID를 통해 추적 화면으로 전환할 수 있다. → 추적 화면에서 트랜잭션 내 다수 스팬을 분석함으로써 어떤 특정 스팬으로 지연이 발생했는지 이해하고 지연이 발생한 시스템과 메서드명을 확인한다. → 만약 지연의 원인이 불분명할 경우 스팬의 로그 URL을 클릭하여 로그 파일로 전환한다. 

로그, 메트릭, 추적의 상관관계를 정의하면 로그, 메트릭, 추적을 한 화면에서 확인함으로써 데이터 분석이 용이해지고 이상 탐지 혹은 장애 예측에 새로운 인사이트를 얻을 수 있다.